name: CI

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

jobs:
  go:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      - name: Build Go SDK
        working-directory: sdk/go
        run: go build ./...
      - name: Go vet
        working-directory: sdk/go
        run: go vet ./...
      - name: Run tests
        working-directory: sdk/go
        run: go test -race -count=1 ./...

  node:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Syntax check Node.js SDK
        run: node -c sdk/nodejs/index.js

  markdown:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate local markdown links
        run: |
          python - <<'PY'
          import pathlib, re, sys
          root = pathlib.Path('.')
          bad = []
          pat = re.compile(r'\[[^\]]+\]\(([^)]+)\)')
          for md in root.rglob('*.md'):
            if '.git' in md.parts:
              continue
            text = md.read_text(encoding='utf-8', errors='ignore')
            for href in pat.findall(text):
              href = href.strip()
              if not href or href.startswith(('http://', 'https://', 'mailto:', '#')):
                continue
              target = href.split('#', 1)[0]
              if not target:
                continue
              path = (md.parent / target).resolve() if not target.startswith('/') else (root / target.lstrip('/'))
              try:
                path.relative_to(root.resolve())
              except Exception:
                bad.append((str(md), href)); continue
              if not path.exists():
                bad.append((str(md), href))
          if bad:
            print('Broken local markdown links:')
            for item in bad:
              print(f' - {item[0]} -> {item[1]}')
            sys.exit(1)
          print('Markdown links: OK')
          PY

  yaml:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate YAML examples
        run: python -c "import yaml, pathlib; [yaml.safe_load(f.read_text()) for f in pathlib.Path('examples').rglob('*.yaml')]"

  publish-npm:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [go, node]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      - name: Publish @integrat/sdk to npm
        working-directory: sdk/nodejs
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
